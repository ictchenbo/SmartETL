from:
  - flows/kafka_news_p1.yaml

description: 接收采集平台通过Kafka推送的网页数据，进行标题、时间、作者、正文等抽取，标题和正文基于大模型翻译，向量化并写入向量库
consts:
  mongo2:
    database: global-news
    collection: news
  qdrant:
    collection: chunk_news_v2
  es1:
    index: goinv3_document_news
  chatglm4: http://10.208.63.29:8888
  bge_large_zh: http://10.208.63.29:8001/embed

nodes:
  select3: Select('id', 'title', 'publish_time', 'site_name', 'author', 'url')
  prompt: util.files.text('config/prompt/news_translate.txt')
  prompt1: util.files.text('config/prompt/news_translate_abs.txt')

  map: Map(int, key='id')
  add_ts: AddTS('inserted_time')
  chain2: Chain(map, add_ts)

  rename: RenameFields(title='title_origin', content='content_origin')
  trans_title: model.GoGPT(api_base=chatglm4, key='title_origin', prompt=prompt, target_key='title')
  translate: model.GoGPT(api_base=chatglm4, key='content_origin', prompt=prompt1, target_key='content')
  write_es: database.ESWriter(**es1, buffer_size=10)
  vector: model.embed.Local(api_base=bge_large_zh, key='content', target_key='vector')
  write_qd: database.qdrant.Qdrant(**qdrant, buffer_size=10)
  fork: Fork(write_es, Chain(vector, write_qd))
  chain3: Chain(rename, trans_title, translate, fork)

processor: Chain(chain, chain2, chain3)

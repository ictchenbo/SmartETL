from: local/db_envs.yaml

name: paper process flow
description: 读取论文元数据，构建简单向量索引

consts:
  bge_large_en: http://10.208.62.156:6008/v1/embeddings
  type_mapping:
    all: .jsonl

nodes:
  qd2: util.database.qdrant.Qdrant(**qdrant, collection='paper-simple-2508', auto_create=True, size=1536)

  select1: SelectVal('data')
  filter1: "Filter(lambda s: s.startswith('2507.'), key='id')"

# 论文ID：`arxiv:<arxiv-id>`
  make_id: "Map(lambda r: 'arxiv:'+r['id'], target_key='_id')"

# 重建文本向量索引
  chunk: Map('gestata.paper.simple_chunk_from_paper', target_key='text')
  vector: Map('gestata.embedding.text_v2', key='text', target_key='vector', api_base=bge_large_en)
  select: Select('_id', 'text', 'vector')
  rename: RenameFields(_id='paper_id')
  write_qd: Map('gestata.dbops.upsert', qd2)

loader: ar.Zip(arg1, 'all', type_mapping=type_mapping)
#processor: Chain(SkipN(2350000), select1, filter1, make_id, Print('_id', 'title'))
processor: Chain(SkipN(2350000), select1, filter1, make_id, chunk, vector, select, rename, Buffer(buffer_size=1000), write_qd, Count(label='chunk'))
